{% extends "base/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block body %}
<div class="container mt-5 search-page">
    <div class="search-bar d-flex justify-content-start gap-3">

        <!-- Search Form -->
        <div>
            <form class="d-flex" id="search-form">
                <div class="autocomplete" id="autocomplete-js">
                    <div class="input-group">
                        <input
                            type="text"
                            class="form-control"
                            id="user-search"
                            name="q"
                            placeholder="Search by Name, Surname"
                            value="{{ form.q.value|default:'' }}"
                            autocomplete="off"
                        >
                        <button type="submit" class="btn">Search</button>
                    </div>
                    <ul class="suggestions" id="suggestions"></ul>
                </div>
            </form>
        </div>

        <!-- Filters Dropdown -->
        <div>
            <div class="dropdown">
                <button
                    class="btn dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                    data-bs-auto-close="false"
                >
                    <i class="bi bi-funnel"></i>
                </button>

                <div class="dropdown-menu p-4 bg-light" style="min-width:300px">
                    <h6 class="fw-bold">Filters</h6>

                    <form action="/search" method="get">
                        <input type="hidden" name="q" value="{{ form.q.value|default:'' }}">

                        <!-- Category -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Category</label>
                            {{ form.p|add_class:"form-control" }}
                        </div>

                        <!-- Location -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Location</label>
                            <input
                                type="text"
                                class="form-control"
                                name="l"
                                id="location-search"
                                value="{{ form.l.value|default:'' }}"
                                placeholder="Enter location"
                                autocomplete="off"
                            >
                        </div>

                        <button type="submit" class="btn btn-sm w-100">
                            Apply Filters
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Active Filters Pills -->
        <div class="d-none d-md-block">
            <span class="d-flex gap-1">
                {% if form.l.value %}
                    <span class="filter-pill p-2">
                        {{ form.l.value }}
                        <a class="bi bi-x"
                           href="/search?q={{ form.q.value|default:'' }}&p={{ form.p.value|default:'' }}">
                        </a>
                    </span>
                {% endif %}
                {% if form.p.value %}
                    <span class="filter-pill p-2">
                        {{ form.p.value }}
                        <a class="bi bi-x"
                           href="/search?q={{ form.q.value|default:'' }}&l={{ form.l.value|default:'' }}">
                        </a>
                    </span>
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- RESULTS -->
{% if users %}
<div class="container mt-4">
    <div class="d-flex justify-content-center">
        <div class="search-card-inner-container d-flex flex-wrap gap-4">
            {% for usr in users %}
                {% include "accounts/user_search_card.html" %}
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
    {% if user.is_authenticated %}
        <p class="text-center text-muted my-5">
            Bhole Baba Ki Jai! <br>No Search Result Found
        </p>
    {% else %}
        <p class="text-center text-muted my-5">
            Bhole Baba Ki Jai! You are not logged in.<br>
            <a href="{% url 'register' %}">Join Us</a>
        </p>
    {% endif %}
{% endif %}

<!-- PAGINATION -->
{% if users %}
<div class="container my-5">
    <nav>
        <ul class="pagination justify-content-center">

            {% if users.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ users.previous_page_number }}
                       {% if request.GET.q %}&q={{ request.GET.q }}{% endif %}
                       {% if request.GET.l %}&l={{ request.GET.l }}{% endif %}
                       {% if request.GET.p %}&p={{ request.GET.p }}{% endif %}">
                        &laquo;
                    </a>
                </li>
            {% endif %}

            {% for num in users.paginator.page_range %}
                {% if num == users.number %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num >= users.number|add:-2 and num <= users.number|add:2 %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ num }}
                           {% if request.GET.q %}&q={{ request.GET.q }}{% endif %}
                           {% if request.GET.l %}&l={{ request.GET.l }}{% endif %}
                           {% if request.GET.p %}&p={{ request.GET.p }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if users.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ users.next_page_number }}
                       {% if request.GET.q %}&q={{ request.GET.q }}{% endif %}
                       {% if request.GET.l %}&l={{ request.GET.l }}{% endif %}
                       {% if request.GET.p %}&p={{ request.GET.p }}{% endif %}">
                        &raquo;
                    </a>
                </li>
            {% endif %}

        </ul>
    </nav>
</div>
{% endif %}
{% endblock body %}

{% block script %}
<script src="{% static 'js/autocomplete.js' %}"></script>
<script src="{% static 'js/autocomplete_location.js' %}"></script>

<script>
// Prevent form reload
document.getElementById('search-form').addEventListener('submit', function(e){
    e.preventDefault();
});

// Optional: Prevent Enter key reload
document.getElementById('user-search').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
        e.preventDefault();
    }
});

// Offcanvas popup (unchanged)
if (document.getElementById('registerOffcanvas')) {
    setInterval(() => {
        const el = document.getElementById('registerOffcanvas');
        if (!el.classList.contains('show')) {
            new bootstrap.Offcanvas(el).show();
        }
    }, 10000);
}
</script>
{% endblock script %}
