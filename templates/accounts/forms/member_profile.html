{% load widget_tweaks %}

<form
    method="post"
    action="{% url 'update_profile' %}"
    enctype="multipart/form-data"
    id="member_profile_form"
    class="me-3"
>
    {% csrf_token %}

    <!-- identify this as profile update form -->
    <input type="hidden" name="form_type" value="profile_update">

    <!-- Bio Field -->
    <div>
        <label for="id_bio" class="label">Tell Us About Yourself (Bio)</label>
        {{ member_profile_form.bio }}
        {% for error in member_profile_form.bio.errors %}
            <small class="text-danger">{{ error }}</small>
        {% endfor %}
    </div>

    <!-- Profile Picture Field -->
    <div class="mt-3">
        <div class="row">
            {% if member_profile_form.instance.profile_picture %}
            <div class="col-auto d-flex justify-content-center align-items-end">
                <img src="{{ user.getProfilePhoto }}" class="d-none d-md-block img-fluid border-2 profile-image border-white rounded-circle" style="height: 4rem; width: 4rem;">
                <img src="{{ user.getProfilePhoto }}" class="d-md-none d-block img-fluid profile-image border-white rounded-3" style="height: 3rem; width: 3rem;">
            </div>
            {% endif %}
            <div class="col">
                <div class="image-upload-container text-center">
                    <div class="input-group mt-1 mt-md-3">
                        <input
                            name="{{ member_profile_form.profile_picture.name }}"
                            type="file"
                            id="{{ member_profile_form.profile_picture.id_for_label }}"
                            accept="image/*"
                            class="form-control"
                        >
                        <a class="btn bg-secondary" id="open-camera-modal">
                            <i class="bi bi-camera"></i>
                        </a>
                        <a class="btn d-none" id="open-crop-modal" disabled>
                            <span class="d-md-block d-none">Preview & Edit</span>
                            <span class="d-block d-md-none">
                                <i class="bi bi-pencil"></i>
                            </span>
                        </a>
                    </div>
                </div>
                <small class="image-errors"></small>
            </div>
        </div>

        {% for error in member_profile_form.profile_picture.errors %}
            <small class="text-danger">{{ error }}</small>
        {% endfor %}
    </div>

    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="error-message"></div>
        <div class="my-3">
            <button type="submit" class="btn">Save</button>
            <a data-click="v-pills-personal-details-tab" class="btn">Previous</a>
            <a data-click="v-pills-professional-info-tab" class="btn">Next</a>
        </div>
    </div>
</form>

<!-- Modal for Preview and Editing -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">Edit Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="preview-container">
                    <img id="image-preview" src="#" alt="Preview" class="img-fluid">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="upload-button">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Camera -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">Capture Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center overflow-hidden d-flex justify-content-center">
                <video id="camera-stream" autoplay class="w-100"></video>
                <canvas id="camera-canvas" class="d-none"></canvas>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button id="capture-image" class="btn btn-primary mt-3">
                    <i class="bi bi-camera fs-4"></i>
                </button>
                <button id="retake-image" class="btn btn-primary mt-3 d-none">
                    <i class="bi bi-recycle fs-4"></i>
                </button>
                <button type="button" id="save-capture" class="btn btn-success d-none mt-3">
                    <i class="bi bi-check-circle fs-4"></i>
                </button>
            </div>
        </div>
    </div>
</div>
